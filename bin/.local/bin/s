#!/usr/bin/env bash

set -e

TMUX_SESSION="ssh"

if ! tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
    tmux_panes=""
else
    tmux_panes=$(tmux list-panes -a -F "#{session_name}:#{window_id}:#{window_name}:#{pane_id}:#{@ssh_host}" | grep --extended-regexp "^${TMUX_SESSION}:")
    tmux_panes="$tmux_panes\n"
fi

ssh_hosts=$(grep --extended-regexp '^Host ' ~/.ssh/config 2> /dev/null | \
        grep -vE '(\*|\?)' | \
        sed 's/^Host //' | \
    sort -u)

fzf_input="$tmux_panes$ssh_hosts"

result=$(echo -e "$fzf_input" | fzf-tmux --header "SSH: Enter=window, C-v=vsplit, C-s=hsplit" --header-first --info=inline --no-sort -w 70 -h 20 --multi --bind="tab:toggle,ctrl-a:toggle-all" --expect="enter,ctrl-v,ctrl-s" || true)

key=$(echo "$result" | head -1)
selection=$(echo "$result" | tail -n +2)

# Exit if nothing selected
if [[ -z "$selection" ]]; then
    exit 0
fi

while IFS= read -r line; do
    [[ -z "$line" ]] && continue

    if [[ "$line" == *:*:*:* ]]; then
        IFS=':' read -r _ window_id _ pane_id _ <<< "$line"
        [[ -n "${TMUX:-}" ]] && tmux switch-client -t "$TMUX_SESSION"
        tmux select-pane -t "$pane_id"
        tmux select-window -t "$window_id"

        current_command=$(tmux list-panes -t "$TMUX_SESSION" -f "#{==:#{pane_id},$pane_id}" -F "#{pane_current_command}")
        if ! echo "$current_command" | grep -qE '^ssh'; then
            ssh_host=$(tmux show-option -pqv @ssh_host || true)
            [[ -n "$ssh_host" ]] && tmux send-keys -t "$TMUX_SESSION:$window_id" "ssh $ssh_host" C-m
        fi
        continue
    fi

    host="$line"
    case "$key" in
        ctrl-v)
            tmux split-window -h "ssh $host"
            ;;
        ctrl-s)
            tmux split-window -v "ssh $host"
            ;;
        *)
            if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
                tmux new-window -t "$TMUX_SESSION" -n "session" "ssh $host"
            else
                tmux new-session -d -s "$TMUX_SESSION" -n "session" "ssh $host"
            fi
            [[ -n "${TMUX:-}" ]] && tmux switch-client -t "$TMUX_SESSION"
            ;;
    esac
    tmux set-option -p @ssh_host "$host"
done <<< "$selection"

if [[ -z "${TMUX:-}" ]]; then
    # Need to do this afterwards, can't do it inside the loop.
    tmux attach -t "$TMUX_SESSION"
fi
